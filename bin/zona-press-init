#!/usr/bin/env node

const moment = require('moment')

const program = require('commander')
const inquirer = require('inquirer')
const path = require('path')
const ora = require('ora')
const Metalsmith = require('metalsmith')
const Handlebars = require('handlebars')
const {checkNodeVer} = require('../utils/index')
const fs = require('fs-extra')

const metalsmith = Metalsmith(path.resolve(__dirname, '../template'))

program.version(require('../package.json').version)
program.parse(process.argv)
program.on('--help', () => {
  console.log('è¿™æ˜¯Help')  
})


// åˆå§‹åŒ–ä¸€äº›è¾“å…¥ä¿¡æ¯

const rawName = program.args[0]
const inPlace = !rawName || rawName === '.'
const name = inPlace ? path.relative('../', process.cwd()) : rawName
const destinationPath = inPlace ? '.' : `./${name}` 

const date = moment().format('YYYY-MM-DD')
const dateWithNoSplit = moment().format('YYYYMMDD')
// å£°æ˜Žhandlebarçš„ä¿¡æ¯



let handleBarsInitData = {
  'projectName': name,
  'firstDate': date
}

// åœ¨æ­¤åˆ¤æ–­æ‰€æœ‰é¡¹ç›®çŽ¯å¢ƒæ˜¯å¦è¾¾æ ‡
checkNodeVer(require('../package.json').engines.node, 'zona-press')

inquirer.prompt([{
  type: 'confirm',
  message: inPlace ? `åœ¨å½“å‰ç›®å½•åˆ›å»º?` : 'æ–°åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',
  name: 'init',
  default: true
}]).then((answers) => {
  if (answers.init) {
    run()
  } else {
    console.log('è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶å¤¹')
  }
})

function run() {
  const spinner = ora({
    text: 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶',
    spinner: {
      interval: 80, // Optional
      frames: [
      'ðŸ‚      ', 
      'ðŸ‚ðŸº    ',
      'ðŸ‚ðŸºðŸº  ',
      'ðŸ‚ðŸºðŸºðŸº',
      'ðŸ‚ðŸºðŸº  ',
      'ðŸ‚ðŸº    ']
    }
  })
  console.log(path.resolve(destinationPath));
  spinner.start()

  metalsmith
  .clean(false)
  .source('.')
  .use((files, metalsmith, done) => {
    let filenames = Object.keys(files)
    let promises = []

    filenames.forEach((filename) => {      

      let promise = fs.readFile(metalsmith.directory() + '/' + filename, 'utf-8')
      promise.then((source) => {
        if (!/{{([^{}]+)}}/g.test(source)) {
          return
        }
        // handleBarsè¿›è¡Œå¡«å……
        console.log(filename)
        if (!(/build\/template.*/.test(filename))) {
          console.log('shit', filename)
          let template = Handlebars.compile(source)
          var result = template(handleBarsInitData);
          files[filename].contents = new Buffer.from(result)
        }

        // ä¸ºç¬¬ä¸€ç¯‡æ–‡ç« æ”¹å
        if (filename === 'articles/First_Article.md') {
          let data = files[filename]
          data.contents = Buffer.from(result)
          Reflect.deleteProperty(files, filename)
          files['articles/' + dateWithNoSplit+ '-First_Article.md'] = data
        }
      })
      promises.push(promise)
    })

    promises.push(new Promise((reslove) => {
      files['build/template/new.md'] = {}
      files['build/template/new.md'].contents = `---
title: {{newTitle}}
image: default.png
time: {{newDate}}
{{newDesc}}
{{newTags}}
---

# {{newTitle}}

å°½æƒ…è‡ªç”±åˆ›ä½œå§ã€‚

`;
reslove()

    }))


    Promise.all(promises).then(() => {
      done()
    })

  })
  .destination(path.resolve(destinationPath))
  .build((err) => {



    if (err) {
      throw err
    }

    setTimeout(() => {
      spinner.stop()
      console.log('build finished')
    }, 1000)
  })
}